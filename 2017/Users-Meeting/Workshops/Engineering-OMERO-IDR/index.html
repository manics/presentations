<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>OME2017 Â» Engineering the IDR</title>

    <meta name="author" content="Simon Li">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="reveal-js/css/reveal.css">
    <link rel="stylesheet" href="reveal-js/css/theme/white.css" id="theme">
    <!--link rel="stylesheet" href="reveal-js/css/theme/league.css" id="theme"-->

    <!-- OME presentation overrides of the default theme -->
    <link rel="stylesheet" href="css/ome-reveal.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="reveal-js/lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal-js/css/print/pdf.css' : 'reveal-js/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
      <script src="reveal-js/lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body class="ome_theme">

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

        <!-- title page -->
        <section class="center">
          <h1>Engineering the IDR</h1>
          <h3>(And how you can too)</h3>
          <h4>Simon Li</h4>
        </section>

        <!-- Introduction -->
        <section>
          <section class="center">
            <h2>Aims of this talk</h2>
            <ul>
              <li>Explain how the IDR systems are deployed and managed</li>
              <li>Show how to automate a large scale OMERO system</li>
              <li>Introduce the principles and resources we use</li>
            </ul>
            <h2 class="fragment">Discussion</h2>
          </section>

          <section data-background="images/idr-screenshot-placeholder.png" data-background-size="1024px" class="fullscreen-image">
            <h2>The Image Data Repository</h2>
            <div>
              <p>A public resource to store, integrate and serve image datasets from published scientific studies.</p>
              <ul>
                <li>42 TB image data</li>
                <li>2.7 million images</li>
                <li>41 studies</li>
              </ul>
            </div>
          </section>

          <section class="center">
            <h2>Behind the scenes</h2>
            <ul>
              <li>98 TB raw data</li>
              <li>15 million files</li>
              <li>19 million annotations</li>
            </ul>
            <aside class="notes">
            Annotation: 2838234
            MapAnnotation: 2828438
            ImageAnnotationLink: 13114596
            WellAnnotationLink: 5420574
	          </aside>
          </section>

          <section class="center">
            <h1>Overview of the current IDR</h1>
          </section>

          <section class="center">
            <div class="box">

              <div class="flexcontainer">
                <div class="flex2 fragment box" data-fragment-index="4">
                  <img src="images/logos/nginx-logo.svg" class="plain" style="width:30%;" />
                  <a href="https://idr.openmicroscopy.org" class="annotatex">https://idr.openmicroscopy.org</a>
                </div>
                <div class="flex1">
                  <img src="images/logos/OpenStack-Logo-Horizontal.png" class="plain" style="width: 70%;" />
                  <img src="images/logos/centos-logo-light-tagline-release7.svg" class="plain" style="width: 70%;" />
                </div>
              </div>

              <div class="flexcontainer">
                <div class="flex1 fragment" data-fragment-index="2">
                  <a href="https://idr.openmicroscopy.org/webclient/userdata/?experimenter=-1" class="annotate">Public IDR backend</a>
                  <div class="box">
                    <img src="images/logos/omero-logo-800.png" class="plain" />
                    <div class="annotate">OMERO.server</div>
                    <div class="annotate">OMERO.web</div>
                  </div>
                  <div class="box fragment" data-fragment-index="3">
                    <img src="images/logos/postgresql-logo.png" class="plain" style="width: 70%;" />
                  </div>
                </div>

                <div class="flex1 fragment" data-fragment-index="5">
                  <a href="https://idr.openmicroscopy.org/jupyter/" class="annotate">IDR analysis</a>
                  <div class="box">
                    <img src="images/logos/jupyterhub-80.png" class="plain" style="width: 70%;" />
                    <img src="images/logos/docker-logo-h-trans.png" class="plain" style="width: 70%;" />
                  </div>
                  <div class="box fragment" data-fragment-index="7">
                    <img src="images/logos/omero-logo-800.png" class="plain" />
                    <div class="annotate">OMERO.server</div>
                  </div>
                  <div class="box fragment" data-fragment-index="7">
                    <img src="images/logos/postgresql-logo.png" class="plain" style="width: 70%;" />
                  </div>
                </div>

                <div class="flex1 fragment" data-fragment-index="8">
                  <a class="annotate">Monitoring system</a>
                  <div class="box">
                    <img src="images/logos/munin.png" class="plain" style="width: 70%;" />
                    <img src="images/logos/prometheus.png" class="plain" style="width: 70%; opacity: 0.5;" />
                  </div>
                </div>

              </div>
            </div>

          </section>

          <section class="center">
            <h2>IDR cloud resources:</h2>
            <h4>76 vCPUs</h4>
            <h4>296 GB RAM</h4>
            <h4>13 TB volatile storage</h4>
          </section>

          <section class="center">
            <h2>Current EBI tenancy</h2>
          </section>
        </section>


        <!-- Devops -->
        <section>
          <section class="center">
            <h1>"Devops"</h1>
            <h3>What is it?</h3>
          </section>

          <section data-background="images/dev-ops-problem.jpg" data-background-size="1024px" class="fullscreen-image">
          </section>

          <section class="center">
            <h2>IDR: Three key concepts</h2>
            <ul>
              <li>Resource virtualisation</li>
              <li>Configuration Management</li>
              <li class="fragment">Develop-Test-Release new datasets</li>
            </ul>
          </section>
        </section>


        <!-- Configuration management -->
        <section>
          <section class="center">
            <h1>Configuration management</h1>
          </section>

          <section class="center">
            <h2>What is configuration management?</h2>

            <div class="flexcontainer">
              <ul class="flex2">
                <li>A systematic way to setup and configure your servers</li>
                <li>"Infrastructure as code"</li>
              </ul>
              <div class="flex1">
                <a href="https://www.ansible.com/">
                  <img src="images/logos/ansible-logo.png" />
                </a>
                <a href="https://saltstack.com/">
                  <img src="images/logos/saltstack-logo.png" />
                </a>
              </div>
              <div class="flex1">
                <a href="https://www.chef.io/">
                  <img src="images/logos/chef_logo.png" />
                </a>
                <a href="https://puppet.com/">
                  <img src="images/logos/puppet-logo.png" />
                </a>
              </div>
            </div>
          </section>

          <section class="center">
            <h2>"Infrastructure as code"</h2>

            <div class="flexcontainer">
              <ul class="flex1">
                <li>Reproducible installations</li>
                <li>Documentation</li>
                <li>Version control</li>
                <li>GitHub code reviews</li>
              </ul>
              <div class="flex1 fragment">
                <a href="https://github.com/openmicroscopy/infrastructure/pulls">
                  <img src="images/infrastructure-prs-20170523.png" />
                </a>
          </section>


          <section class="center">
            <h2>What can it do for OMERO?</h2>

            <div class="flexcontainer">
              <ul class="flex1">
                <li>Open-source our <a href="https://github.com/openmicroscopy/infrastructure">infrastructure</a></li>
                <li>Manage all dependencies</li>
                <li>Install, configure, upgrade</li>
              </ul>
              <div class="flex1">
                <a href="http://www.openmicroscopy.org/site/support/omero5.3/sysadmins/index.html">
                  <img src="images/ome-sysadmin-install-docs.png" />
                </a>
              </div>
            </div>
          </section>

          <section class="center">
            <h2>Ansible</h2>
          </section>
        </section>


        <!-- OMERO all-in-one -->
        <section>
          <section class="center">
            <h2>Ansible roles</h2>
            <div class="flexcontainer">
              <div class="flex1">
                <a href="https://galaxy.ansible.com/openmicroscopy/">
                  <img src="images/ansible-galaxy-openmicroscopy-head.png" />
                </a>
              </div>
              <ul class="flex" style="list-style-image: url('images/logos/ansible-a-24.png');">
                <li><a href="https://galaxy.ansible.com/openmicroscopy/omero-server/">omero-server role</a></li>
                <li><a href="https://galaxy.ansible.com/openmicroscopy/omero-web/">omero-web role</a></li>
              </ul>
          </section>


          <section class="center">
            <div class="flexcontainer">
              <h4 class="flex1">
TODO
                All-in-one OMERO.server
              </h4>
              <div class="flex3">
                <pre class="small"><code data-trim class="yaml">
# playbook-1.yml
- hosts: localhost
  roles:
  - openmicroscopy.omero-server
  vars:
    postgresql_users_databases:
    - user: omero
      password: omero
      databases: [omero]
                </code></pre>
              </div>
            </div>
            <div>
              <pre class="small"><code data-trim class="bash">
ansible-playbook playbook-1.yml
              </code></pre>
            </div>
          </section>
        </section>

        <!-- Scaling up -->
        <section>
          <section class="center">
            <div class="flexcontainer">
              <h4 class="flex1">
TODO
                Separate database
              </h4>
              <div class="flex3">
                <pre class="small"><code data-trim class="yaml">
# playbook-2.yml
- hosts: localhost
  roles:
  - openmicroscopy.omero-server
  vars:
    postgresql_users_databases:
    - user: omero
      password: omero
      databases: [omero]
                </code></pre>
              </div>
            </div>
            <div>
              <pre class="small"><code data-trim class="bash">
ansible-playbook playbook-2.yml
              </code></pre>
            </div>
          </section>

          <section class="center">
            <div class="flexcontainer">
              <h4 class="flex1">
TODO
                Separate database, OMERO.server, OMERO.web
              </h4>
              <div class="flex3">
                <pre class="small"><code data-trim class="yaml">
# playbook-3.yml
- hosts: localhost
  roles:
  - openmicroscopy.omero-server
  vars:
    postgresql_users_databases:
    - user: omero
      password: omero
      databases: [omero]
                </code></pre>
              </div>
            </div>
            <div>
              <pre class="small"><code data-trim class="bash">
ansible-playbook playbook-3.yml
              </code></pre>
            </div>
          </section>

          <section class="center">
            <h2>Public OMERO.web configuration</h2>
            <div class="flexcontainer">
              <div style="width: 75%;">
                <pre class="small"><code data-trim class="yaml">
omero_web_config_set:
  omero.web.public.enabled: True
  omero.web.public.server_id: 1
  omero.web.public.user: public
  omero.web.public.password: password
  omero.web.public.url_filter: "^/(webadmin/myphoto/|webclient/(?!(action|logout|annotate_(file|tags|comment|rating|map)|script_ui|ome_tiff|figure_script))|webgateway/(?!(archived_files|download_as)))"
                </code></pre>
              </div>
              <div style="float: right;">
                <a href="https://github.com/openmicroscopy/ansible-public-omero-example" class="annotate">
                  <img src="images/github-ansible-public-omero-example-repo.png" />
                </a>
              </div>
            </div>
            <a href="https://github.com/openmicroscopy/ansible-public-omero-example" class="annotate">          https://github.com/openmicroscopy/ansible-public-omero-example/</a>
          </section>

          <section class="center">
            <h2>IDR: Deployment and configuration</h2>
            <div class="flexcontainer"</div>
              <div class="flex1">
                <a href="https://idr.openmicroscopy.org/about/deployment.html" class="annotate">
                  <img src="images/idr-about-deployment.png" />
                  https://idr.openmicroscopy.org/about/deployment.html
                </a>
              </div>
              <div class="flex1">
                <a href="https://github.com/IDR/deployment/" class="annotate">
                  <img src="images/github-idr-deployment-repo.png" />
                  https://github.com/IDR/deployment/
                </a>
              </div>
            </div>
          </section>



        </section>


        <!-- Virtualisation -->
        <section>
          <section class="center">
            <h2>Clouds</h2>
          </section>

          <section class="center">
            <h2>Openstack</h2>
          </section>

          <section class="center">
            <h2>Ansible</h2>
          </section>
        </section>


        <!-- Public IDR -->
        <section>
          <section class="center">
            <h2>Cloud provisioning and snapshots</h2>
          </section>

          <section class="center">
            <h2>Front-end caching proxy</h2>
          </section>

          <section class="center">
            <h2>Performance tuning</h2>
            <ul>
              <li>OMERO.server: Bio-Formats cache</li>
              <li>OMERO.web: Optimise queries and HTTP requests</li>
              <li>Nginx: Very aggressive front-end caching, pre-warmed</li>
            </ul>
          </section>
        </section>


        <!-- VAE -->
        <section>
          <section class="center">
            <h2>VAE</h2>
          </section>

          <section class="center">
            <h2>Storage snapshots</h2>
          </section>

          <section class="center">
            <h2>Docker</h2>
          </section>
        </section>


        <!-- Full IDR -->
        <section>
          <section class="center">
            <h2>IDR</h2>
            <p>Full deployment with one command</p>
          </section>

          <section data-background="images/embassy-topology-2.png" class="fullscreen-image">
            <h2 class="fragment">Current EBI deployments</h2>
            <div class="fragment">Three full IDRs running concurrently:
              <ul>
                <li>Current production IDR</li>
                <li>Testing environment</li>
                <li>Next release</li>
              </ul>
            </div>
            <div class="fragment">Additional services:
              <ul>
                <li>Continuous integration</li>
              </ul>
            </div>
          </section>
        </section>


        <section class="center">
          <h2>Summary so far</h2>
          <ul>
            <li class="fragment">Automatically installed and configured OMERO</li>
            <li class="fragment">Split across multiple servers</li>
            <li class="fragment">Automatically provisioned virtual machines and storage</li>
            <li class="fragment">Deployed multiple copies of the IDR</li>
          </ul>
        </section>


        <!-- Docker -->
        <section>
          <section class="center">
            <h2>Docker</h2>
          </section>

          <section class="center">
            <h2>JupyterHub behind the scenes</h2>
          </section>

          <section class="center">
            <h2>Docker images</h2>
          </section>

          <section class="center">
            <h2>Docker or OpenStack?</h2>
          </section>
        </section>


        <!-- Images -->
        <section>
          <section class="center">
            <h2>Building cloud images</h2>
          </section>

          <section class="center">
            <h2>OpenStack image using Ansible</h2>
          </section>

          <section class="center">
            <h2>Docker image using Ansible</h2>
          </section>
        </section>


        <!-- Summary -->
        <section>
          <section class="center">
            <h2>Recap</h2>
          </section>
        </section>


        <!-- Discussion topics -->
        <section>
          <section class="center">
            <h2>Topics for discussion</h2>
          </section>
        </section>



        <section class="center">
          <h2>OMERO on Docker on virtual machines?</h2>

          <ul class="nobullet">
            <li><span style="color:green;">&#10004;</span> Easy to deploy OMERO</li>
            <li><span style="color:green;">&#10004;</span> Easy to upgrade</li>
            <li><span style="color:red;">&#10008;</span> Another layer of infrastructure to debug</li>
          </ul>
          <p class="fragment">What we'd really like: someone else to manage the infrastructure</p>
        </section>




        <section data-background="images/openstack-network-1.png" data-background-size="1024px" class="fullscreen-image">
          <img src="images/ansible-terminal-1.png" style="width:40%; opacity:0.7; float:left;" />
        </section>




        <section class="center">
          <dl>
            <h2>Resources</h2>
            <dt>OME Ansible roles</dt>
            <dd><a href="https://galaxy.ansible.com/openmicroscopy/">https://galaxy.ansible.com/openmicroscopy/</a></dd>
            <dt>Example OMERO.server playbook</dt>
            <dd><a href="https://github.com/openmicroscopy/ansible-public-omero-example">https://github.com/openmicroscopy/ansible-public-omero-example</a></dd>
            <dt>IDR Deployment playbooks and configuration</dt>
            <dd><a href="https://github.com/IDR/deployment/">https://github.com/IDR/deployment/</a></dd>
          </dl>
        </section>

        <section class="center">
          <h2>Thank you</h2>
          <ul>
            <li>Prof. Jason Swedlow</li>
            <li>OME team</li>
          </ul>
          <br/><br/>
          <div style="background-color: #fff;">
            <img src="images/logos/wellcome.png" height="140px">
            <img src="images/logos/bbsrc.png" height="140px">
          </div>
        </section>

      </div>

    </div>



    <script src="reveal-js/lib/js/head.min.js"></script>
    <script src="reveal-js/js/reveal.js"></script>

    <script>
      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: false,

        transition: 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'reveal-js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });
    </script>

  </body>
</html>
